---
title: "Untitled"
author: "Aaron Owen"
date: "10/19/2017"
output: html_document
---

```{r}
library(ggplot2)
library(dplyr)
profs = read.csv("profs.csv", stringsAsFactors = F)
profs = profs %>% select(-X, -X.1)
```

```{r}
head(profs)
```

```{r}
profs$department[grepl("Biological", profs$department)] = "Biology"
profs$department[grepl("Business Te", profs$department)] = "Business"
profs[profs$department == "Science", ]$department = "Physical Sciences"
profs$department[grepl("Theater|Speech", profs$department)] = "Communication"
profs[profs$name == "Greco, Joseph", ]$department = "Communication"
profs[profs$name == "Sokolski, Patricia", ]$department = "Communication"
profs$department[grepl("Allied", profs$department)] = "Health Science"
profs$department[grepl("Health & Physical Education|Physical Education", profs$department)] = "Physical Ed"
profs$department[grepl("Art", profs$department)] = "Art"
profs$department[grepl("Legal", profs$department)] = "Law"
profs$department[grepl("African|Ethnic|Women", profs$department)] = "Cultural Studies"
profs$department[grepl("Foreign|Spanish", profs$department)] = "Languages"
profs$department[grepl("Info", profs$department)] = "Social Science"
profs[profs$name == "Townsend, Charles", ]$department = "Social Science"
profs[profs$name == "Ruiz, Roberto", ]$department = "Philosophy"
profs$department[grepl("History|Political|Philosophy", profs$department)] = "History, Philosophy, Poly Sci"
profs = profs %>% mutate(chili = ifelse(grepl("True", chili), "attractive", "not attractive"))
```

```{r}
profs["total_tags"] = apply(profs[10:29], 1, sum, na.rm = T)
```

```{r}
grouped_profs = 
    profs %>% group_by(name, school, sex, department) %>% 
        summarise_if(is.numeric, mean, na.rm = T) %>% 
        mutate(
           acc.out.class.prop = accessible.outside.class/total_tags * 100,
           amaz.lect.prop = amazing.lectures/total_tags * 100,
           pop.quiz.prop = beware.of.pop.quizzes/total_tags * 100,
           caring.prop = caring/total_tags * 100,
           grad.crit.prop = clear.grading.criteria/total_tags * 100,
           ext.cred.prop = extra.credit/total_tags * 100,
           read.prop = get.ready.to.read/total_tags * 100,
           feedback.pop = gives.good.feedback/total_tags * 100,
           few.things.prop = graded.by.few.things/total_tags * 100,
           group.proj.prop = group.projects/total_tags * 100,
           hilarious.pop = hilarious/total_tags * 100,
           inspirational.prop = inspirational/total_tags * 100,
           lecture.heavy.prop = lecture.heavy/total_tags * 100,
           homework.prop = lots.of.homework/total_tags * 100,
           participation.prop = participation.matters/total_tags * 100,
           respected.prop = respected/total_tags * 100,
           skip.class.prop = skip.class.you.wont.pass/total_tags * 100,
           many.papers.prop = so.many.papers/total_tags * 100,
           test.heavy.prop = test.heavy/total_tags * 100,
           tough.grader.prop = tough.grader/total_tags * 100)
```

```{r}
grouped_profs = grouped_profs %>% rename(overall_score_mean = overall_score, difficulty_score_mean = difficulty_score)
grouped_profs[, -(5:27)]
```

```{r}
profs = merge(profs, grouped_profs[, -(5:27)], by = c("name"), suffixes = c("", "_y")) %>% select(-school_y, -sex_y, -department_y)
write.csv(profs, "profs_cleaned.csv")
```

```{r}
df = profs %>% filter(school == "qns", department == "Accounting")
all = as.data.frame(table(df$overall_score, df$difficulty_score, df$sex))

all$prop = 0

names(all) = c("overall_score", "difficulty_score", "sex", "count", "proportion")

all[c(1:45), 5] = round(all[1:45, 4] / sum(all[1:45, 4]) * 100, 1)
all[c(46:90), 5] = round(all[46:90, 4] / sum(all[46:90, 4]) * 100, 1)

ggplot(all, aes(difficulty_score, overall_score, fill = count)) +
    geom_tile() +
    geom_text(aes(label = proportion, colour = sex, hjust = ifelse(sex == "female", 1.5, -0.5))) +
    scale_colour_manual("% Sex", values = c("red","green"))

# profs %>% filter(department == "Physics", school == "lg")
# 
# unique(profs[school == "lg", "department"])
# unique(profs[profs$school == "lg", ]$department)
# profs %>% select(department) %>% unique() %>% arrange(department)
# 
# profs %>% filter(school == "qns", department == "Accounting", name == "Villani, Kathleen")

df = profs %>% filter(school == "qns", department == "Biology")
to_merge = as.data.frame(table(df$overall_score, df$difficulty_score, df$chili))

# don't know how many chilis and not chilis there are for each cell in the grid
dummy = data.frame(Var1 = as.factor(rep(c(1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5), 10)), Var2 = as.factor(rep(1:5, 18)))
#, Var3 = as.factor(c(rep("attractive", 45), rep("not attractive", 45))))

all = merge(dummy, to_merge, on = c(Var1, Var2), all = T)

all$Var3 = as.character(all$Var3)

all[is.na(all$Var3), ]$Var3 = "not rated"

all[is.na(all)] = 0

all$prop = 0

names(all) = c("overall_score", "difficulty_score", "pepper", "count", "proportion")

all[c(1:45), 5] = round(all[1:45, 4] / sum(all[1:45, 4]) * 100, 1)
all[c(46:90), 5] = round(all[46:90, 4] / sum(all[46:90, 4]) * 100, 1)

all[all$pepper == "not rated", ]$proportion = "not rated"

ggplot(all, aes(difficulty_score, overall_score, fill = count)) +
    geom_tile() +
    geom_text(aes(label = proportion, color = pepper, 
                  hjust = ifelse(pepper == "not rating", 0.5, ifelse(pepper == "attractive", 1.5, -0.5)))) +
                      #pepper == "attractive", 1.5, ifelse(pepper == "not attractive", -0.5, 0)))) +
    scale_colour_manual("% chili", values = c("red","green", "black"))

all

```

```{r}
df = profs %>% filter(department == "Physics")
all = as.data.frame(table(df$overall_score, df$difficulty_score, df$sex))

all$prop = 0

all[c(1:45), 5] = round(all[1:45, 4] / sum(all[1:45, 4]) * 100, 1)
all[c(46:90), 5] = round(all[46:90, 4] / sum(all[46:90, 4]) * 100, 1)

ggplot(all, aes(Var2, Var1, fill = Freq)) +
    geom_tile() +
    geom_text(aes(label = prop,colour = Var3, hjust = ifelse(Var3 == "female", 1.5, -0.5))) +
    scale_colour_manual("% Sex", values = c("red","green"))

```

```{r}
ggplot(all, aes(x = Var2, y = Var1)) + geom_tile(aes(fill = Freq)) + 
    annotate("text", x = 0.75, y = 1, label = round(female$Freq[1] / all$Freq[1]  * 100, 1), color = "red") +
    annotate("text", x = 1.25, y = 1, label = round(male$Freq[1]  / all$Freq[1] * 100, 1), color = "white") +
    annotate("text", x = 0.75, y = 2, label = round(female$Freq[2] / all$Freq[2]  * 100, 1), color = "red") +
    annotate("text", x = 1.25, y = 2, label = round(male$Freq[2]  / all$Freq[2] * 100, 1), color = "white") +
    annotate("text", x = 0.75, y = 3, label = round(female$Freq[3] / all$Freq[3]  * 100, 1), color = "red") +
    annotate("text", x = 1.25, y = 3, label = round(male$Freq[3]  / all$Freq[3] * 100, 1), color = "white") # +
    # annotate("text", x = 0.75, y = 4, label = round(female$Freq[4] / all$Freq[4]  * 100, 1), color = "red") +
    # annotate("text", x = 1.25, y = 4, label = round(male$Freq[4]  / all$Freq[4] * 100, 1), color = "white") +
    # annotate("text", x = 0.75, y = 5, label = round(female$Freq[5] / all$Freq[5]  * 100, 1), color = "red") +
    # annotate("text", x = 1.25, y = 5, label = round(male$Freq[5]  / all$Freq[5] * 100, 1), color = "white") +
    # annotate("text", x = 0.75, y = 6, label = round(female$Freq[6] / all$Freq[6]  * 100, 1), color = "red") +
    # annotate("text", x = 1.25, y = 6, label = round(male$Freq[6]  / all$Freq[6] * 100, 1), color = "white") + 
    # annotate("text", x = 0.75, y = 1, label = round(female$Freq[1] / all$Freq[1]  * 100, 1), color = "red") +
    # annotate("text", x = 1.25, y = 1, label = round(male$Freq[1]  / all$Freq[1] * 100, 1), color = "white") +
    # annotate("text", x = 0.75, y = 2, label = round(female$Freq[2] / all$Freq[2]  * 100, 1), color = "red") +
    # annotate("text", x = 1.25, y = 2, label = round(male$Freq[2]  / all$Freq[2] * 100, 1), color = "white") +
    # annotate("text", x = 0.75, y = 3, label = round(female$Freq[3] / all$Freq[3]  * 100, 1), color = "red") +
    # annotate("text", x = 1.25, y = 3, label = round(male$Freq[3]  / all$Freq[3] * 100, 1), color = "white") +
    # annotate("text", x = 0.75, y = 4, label = round(female$Freq[4] / all$Freq[4]  * 100, 1), color = "red") +
    # annotate("text", x = 1.25, y = 4, label = round(male$Freq[4]  / all$Freq[4] * 100, 1), color = "white") +
    # annotate("text", x = 0.75, y = 5, label = round(female$Freq[5] / all$Freq[5]  * 100, 1), color = "red") +
    # annotate("text", x = 1.25, y = 5, label = round(male$Freq[5]  / all$Freq[5] * 100, 1), color = "white") +
    # annotate("text", x = 0.75, y = 6, label = round(female$Freq[6] / all$Freq[6]  * 100, 1), color = "red") +
    # annotate("text", x = 1.25, y = 6, label = round(male$Freq[6]  / all$Freq[6] * 100, 1), color = "white")

```

```{r}
profs %>% filter(department == "Physics") %>%
    ggplot(aes(x = difficulty_score, y = overall_score)) +
    geom_point(position = "jitter", alpha = 0.03, color = "white") +
    stat_sum(inherit.aes = F, aes(x = difficulty_score, y = overall_score, 
                                color = sex, label = paste(round(..prop.. * 100, 1))), 
           size = 4, geom = "text", position = position_dodge(width = 0.8)) + 
    scale_color_manual(values = c("red", "orange")) + 
    theme(panel.background = element_rect(fill = "black"), panel.grid.major = element_blank(),
          panel.grid.minor.y = element_blank()) +
    geom_hline(yintercept = 0.75, color = "white") +
    geom_hline(yintercept = 1.25, color = "white") +
    geom_hline(yintercept = 1.75, color = "white") +
    geom_hline(yintercept = 2.25, color = "white") +
    geom_hline(yintercept = 2.75, color = "white") +
    geom_hline(yintercept = 3.25, color = "white") +
    geom_hline(yintercept = 3.75, color = "white") +
    geom_hline(yintercept = 4.25, color = "white") +
    geom_hline(yintercept = 4.75, color = "white") +
    geom_hline(yintercept = 5.25, color = "white")


```

```{r}
z = data.frame(x = 1:10, y = 2:11)
ggplot(z, aes(x = x, y = y)) + geom_point() + for (i in 1:nrow(z)) {
    annotate("text", x = 0.3, y = 3, label = "hi", color = "black")
}

d <- expand.grid(x=1:5,y=1:5)
d$z <- rnorm(nrow(d))
d$label <- sample("23.5", size = nrow(d), replace = TRUE)
d$label2 = sample("99.0", size = nrow(d), replace = TRUE)
d$sex = c("M", "M", "M", "M", "M", "F", "F", "F", "F", "F")

ggplot(d, aes(x,y,fill=z)) + geom_tile() +
    geom_text(aes(label=label, color = sex), nudge_x = 0.2) +
    geom_text(aes(label=label2), nudge_x = -.2) +
    
d <- expand.grid(x=1:5,y=1:5)
d$z <- rnorm(nrow(d))
d$f <- sample("35", size = nrow(d), replace = TRUE)
d$m <- sample("65", size = nrow(d), replace = TRUE)

d
dd <- tidyr::gather(d, gender, label, -x,-y,-z)
dd
ggplot(dd, aes(x,y,fill=z)) + geom_tile() +
  geom_text(aes(label=label,colour=gender, hjust = ifelse(gender=="f", 1.5,-0.5))) +
  scale_colour_manual("gender", values=c("pink","green"))
        
    # annotate("text", x = 0.75, y = 1, label = round(female$Freq[1] / all$Freq[1]  * 100, 1), color = "red")
```

```{r}
abc = profs %>% filter(department == "Chemistry") %>% group_by(school) %>% summarise(overall = mean(overall_score), diff = mean(difficulty_score))
xyz = tidyr::gather(abc,rating, score, -school)
ggplot(xyz, aes(x = school, y = score, fill = rating)) + geom_bar(stat = "identity", position = "dodge")
# ggplot(y, aes(x = Complaint.Type2, y = count, fill = Complaint.Type2)) + geom_bar(stat = "identity") + coord_flip()
```

```{r}
x = grouped_profs[, c(1:4, 28:47)] %>% group_by(school, department) %>% summarise_if(is.numeric, mean, na.rm = T)
write.csv(z, "tidy_grouped_profs.csv")

x
class(z)

tidyr::gather(x, props, values, -school, -department) %>% filter(props == "tough.grader.prop", department == "Biology") %>% 
    ggplot(aes(x = props, y = values, fill = school)) +
    geom_bar(stat = "identity", position = "dodge")

# grouped_profs %>% filter(school == "king", department == "Biology") %>% summarise(mean(tough.grader.prop))
```

```{r}
profs %>% filter(department == "Biology") %>% select(content)

content_vec = profs[profs$department == "Biology", "content"]

print(content[1:3])

x = c("hi", "hello", "whatsup")

paste(x, collapse = " ")

content = length(paste(content_vec, collapse = " "))

library(tm)
library(wordcloud)
library(memoise)

my_corp = Corpus(VectorSource(content_vec))
my_corp = tm_map(my_corp, content_transformer(tolower))
my_corp = tm_map(my_corp, removePunctuation)
my_corp = tm_map(my_corp, removeNumbers)
my_corp = tm_map(my_corp, removeWords,
                 c(stopwords("SMART"), "the", "and", "you", "his", "she", "professor", "her", "for", "but",
                   "are", "will", "take", "him", "this", "have", "that", "with", "all", "was", "your", "dont",
                   "prof", "teacher", "hes", "makes", "lot", "make", "doesnt", "shes", "student", "taking",
                   "professors", "youll", "person", "teaches", "ive", "highly", "guy", "youre", "made", "class"))

myDTM = TermDocumentMatrix(my_corp, control = list(minWordLength = 1))

m = as.matrix(myDTM)
v = sort(rowSums(m), decreasing = T)
d = data.frame(word = names(v), freq = v)

head(d, 10)

set.seed(1234)
wordcloud(words = d$word, freq = d$freq, scale = c(4, 0.05), min.freq = 10,
          max.words = 100, random.order = F, rot.per = 0.35, colors = brewer.pal(8, "Dark2"))
```











