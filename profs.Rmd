---
title: "Untitled"
author: "Aaron Owen"
date: "10/19/2017"
output: html_document
---

```{r}
## read in the data

library(ggplot2)
library(dplyr)
profs = read.csv("profs.csv", stringsAsFactors = F)
profs = profs %>% select(-X, -X.1)
```

```{r}
# check data

head(profs)
```

```{r}
# concatenate similar departments

profs$department[grepl("Biological", profs$department)] = "Biology"
profs$department[grepl("Business Te", profs$department)] = "Business"
profs[profs$department == "Science", ]$department = "Physical Sciences"
profs$department[grepl("Theater|Speech", profs$department)] = "Communication"
profs[profs$name == "Greco, Joseph", ]$department = "Communication"
profs[profs$name == "Sokolski, Patricia", ]$department = "Communication"
profs$department[grepl("Allied", profs$department)] = "Health Science"
profs$department[grepl("Health & Physical Education|Physical Education", profs$department)] = "Physical Ed"
profs$department[grepl("Art", profs$department)] = "Art"
profs$department[grepl("Legal", profs$department)] = "Law"
profs$department[grepl("African|Ethnic|Women", profs$department)] = "Cultural Studies"
profs$department[grepl("Foreign|Spanish", profs$department)] = "Languages"
profs$department[grepl("Info", profs$department)] = "Social Science"
profs[profs$name == "Townsend, Charles", ]$department = "Social Science"
profs[profs$name == "Ruiz, Roberto", ]$department = "Philosophy"
profs$department[grepl("History|Political|Philosophy", profs$department)] = "History, Philosophy, Poly Sci"
profs = profs %>% mutate(chili = ifelse(grepl("True", chili), "attractive", "not attractive"))
```

```{r}
# enumerate total tags for each each row

profs["total_tags"] = apply(profs[10:29], 1, sum, na.rm = T)
```

```{r}
# rename schools

profs[profs$school == "qns", ]$school = "Queensboro CC"
profs[profs$school == "king", ]$school = "Kingsboro CC"
profs[profs$school == "nas", ]$school = "Nassau CC"
profs[profs$school == "lg", ]$school = "LaGuardia CC"
profs[profs$school == "man", ]$school = "Borough of Manhattan CC"
```

```{r}
# aggregating tag proportions

grouped_profs = 
    profs %>% group_by(name, school, sex, department) %>%
        summarise_if(is.numeric, mean, na.rm = T) %>% 
        mutate(
           `Accessible Outside of Class` = accessible.outside.class/total_tags * 100,
           `Amazing Lectures` = amazing.lectures/total_tags * 100,
           `Beware of Pop Quizzes` = beware.of.pop.quizzes/total_tags * 100,
           Caring = caring/total_tags * 100,
           `Clear Grading Criteria` = clear.grading.criteria/total_tags * 100,
           `Extra Credit` = extra.credit/total_tags * 100,
           `Get Ready to Read` = get.ready.to.read/total_tags * 100,
           `Gives Good Feedback` = gives.good.feedback/total_tags * 100,
           `Graded by Few Things` = graded.by.few.things/total_tags * 100,
           `Group Projects` = group.projects/total_tags * 100,
           Hilarious = hilarious/total_tags * 100,
           Inspirational = inspirational/total_tags * 100,
           `Lecture Heavy` = lecture.heavy/total_tags * 100,
           `Lots of Homework` = lots.of.homework/total_tags * 100,
           `Participation Matters` = participation.matters/total_tags * 100,
           Respected = respected/total_tags * 100,
           `Skip Class You won't Pass` = skip.class.you.wont.pass/total_tags * 100,
           `So Many Papers` = so.many.papers/total_tags * 100,
           `Test Heavy` = test.heavy/total_tags * 100,
           `Tough Grader` = tough.grader/total_tags * 100)
```

```{r}
# renaming columns

grouped_profs = grouped_profs %>% rename(overall_score_mean = overall_score, difficulty_score_mean = difficulty_score)
grouped_profs[, -(5:27)] # only the new, aggregated columns
```

```{r}
# merging newly aggregating columns back to original data

profs = merge(profs, grouped_profs[, -(5:27)], by = c("name"), suffixes = c("", "_y")) %>% 
    select(-school_y, -sex_y, -department_y)

# exporting data
# write.csv(profs, "profs_cleaned2.csv")
```

```{r}
## trying to plot overall score onto difficulty ##

df = profs %>% filter(school == "Queensboro CC", department == c("Accounting", "Biology", "Business"))

## creating dummy data set to merge back onto original
to_merge = as.data.frame(table(df$overall_score, df$difficulty_score, df$sex))
dummy = data.frame(Var1 = as.factor(rep(c(1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5), 10)), 
                   Var2 = as.factor(rep(1:5, 18)), 
                   Var3 = as.factor(c(rep("female", 45), rep("male", 45))))

# can't seem to get merge on just V1 and V2 or to work, so create a dummy data set with V3, which includes 45 m and 45 f
all = merge(dummy, to_merge, on = c(Var1, Var2, Var3), all.x = T)

# make NAs be zero
all[is.na(all)] = 0

# create new column to compute proportions
all$prop = 0

names(all) = c("overall_score", "difficulty_score", "sex", "count", "proportion")

# order by sex so that first 45 rows are female and last 45 are male
all = all %>% arrange(sex)

# populating prop column for both sexes
all[c(1:45), 5] = round(all[1:45, 4] / sum(all[1:45, 4]) * 100, 1)
all[c(46:90), 5] = round(all[46:90, 4] / sum(all[46:90, 4]) * 100, 1)

# plotting tile proportions for male and female inside each tile
ggplot(all, aes(difficulty_score, overall_score, fill = count)) +
    geom_tile() +
    geom_text(aes(label = proportion, color = sex, hjust = ifelse(sex == "female", 1.5, -0.5))) +
    scale_colour_manual("% Sex", values = c("red","green"))

# don't know how many chilis and not chilis there are for each cell in the grid so can't create similar dummy df
```

```{r}
## comparing regression lines for sex and chili ##

profs %>% ggplot(aes(x = difficulty_score, y = overall_score)) + geom_point(position = "jitter") +
    geom_smooth(aes(color = chili), method = "lm", se = F, show.legend = F) +
    geom_smooth(aes(color = sex), method = "lm", se = F, show.legend = F)

profs %>% ggplot(aes(x = difficulty_score, y = overall_score)) + geom_point(position = "jitter", show.legend = F) +
    geom_smooth(aes(color = chili), method = "lm", se = F, show.legend = F)

profs %>% ggplot(aes(x = difficulty_score, y = overall_score)) + geom_point(position = "jitter", show.legend = F) +
    geom_smooth(aes(color = sex), method = "lm", se = F, show.legend = F)

summary(lm(profs$overall_score ~ profs$difficulty_score + profs$sex + profs$chili))


```

```{r}
## dodged difficulty/rating plots by school and department ##

abc = profs %>% filter(department == "Chemistry") %>% group_by(school) %>% summarise(overall = mean(overall_score), diff = mean(difficulty_score))
xyz = tidyr::gather(abc,rating, score, -school)
ggplot(xyz, aes(x = school, y = score, fill = rating)) + geom_bar(stat = "identity", position = "dodge")
```

```{r}
## creating tag proportion plots ##

#write.csv(x, "grouped_profs3.csv")

df = grouped_profs %>% select(`Tough Grader`, department, school) %>% 
    filter(department == "English") %>% 
    group_by(school)

ggplot(df, aes(x = school, y = `Tough Grader`, fill = school)) + 
    geom_bar(stat = "identity", show.legend = F)

```

```{r}
## experimenting with wordclouds ##

library(tm)
library(wordcloud)
library(memoise)

z = profs %>% filter(department == "Biology") %>% group_by(school) %>% select(school, content)
man_vec = z[z$school == "Borough of Manhattan CC", ][[2]]
lag_vec = z[z$school == "LaGuardia CC", ][[2]]
qns_vec = z[z$school == "Queensboro CC", ][[2]]
kng_vec = z[z$school == "Kingsboro CC", ][[2]]
nas_vec = z[z$school == "Nassau CC", ][[2]]

content_vec = profs[profs$department == "Biology", "content"]

my_corp = Corpus(VectorSource(content_vec))
my_corp = tm_map(my_corp, content_transformer(tolower))
my_corp = tm_map(my_corp, removePunctuation)
my_corp = tm_map(my_corp, removeNumbers)
my_corp = tm_map(my_corp, removeWords,
                 c(stopwords("SMART"), "the", "and", "you", "his", "she", "professor", "her", "for", "but",
                   "are", "will", "take", "him", "this", "have", "that", "with", "all", "was", "your", "dont",
                   "prof", "teacher", "hes", "makes", "lot", "make", "doesnt", "shes", "student", "taking",
                   "professors", "youll", "person", "teaches", "ive", "highly", "guy", "youre", "made", "class"))

myDTM = TermDocumentMatrix(my_corp, control = list(minWordLength = 1))

m = as.matrix(myDTM)
v = sort(rowSums(m), decreasing = T)
d = data.frame(word = names(v), freq = v)

# set.seed(1234)
wordcloud(words = d$word, freq = d$freq, scale = c(4, 0.05), min.freq = 10,
          max.words = 100, random.order = F, rot.per = 0.35, colors = brewer.pal(8, "Dark2"))
```













